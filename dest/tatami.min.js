/*! tatami 2014-03-15 */
(function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J,K,L,M,N,O;k={name:"Tatami",version:"0.1.1-alpha"},h=1,b=2,o=3,c=4,j=5,i=6,m=7,d=8,f=9,g=10,e=11,l=12,n=/^[0-9A-Z_.]+[^_.]?$/i,O={},a=jQuery,L={storage:!!window.localStorage},B={key:{storage:["sandboxStarted","config","fn","buffer","pool","i18n","web_api"]}},K={sandboxStarted:!1,config:{debug:!0,platform:"",api:"",lang:(document.documentElement.lang||document.documentElement.getAttribute("lang")||navigator.language||navigator.browserLanguage).split("-")[0]},fn:{prepare:[],ready:[],init:{systemDialog:a.noop,ajaxHandler:function(b,c){return{success:function(d){var e;return e=J(arguments),d.code>0?a.isFunction(b)?b.apply(a,e):void 0:a.isFunction(c)?c.apply(a,e):M("alert",d.message)},error:a.noop}}},handler:{}},buffer:{},pool:{},i18n:{_SYS:{dialog:{zh:{title:"系统提示",close:"关闭",ok:"确定",cancel:"取消",yes:"是",no:"否"},en:{title:"System",close:"Close",ok:"Ok",cancel:"Cancel",yes:"Yes",no:"No"}}}},web_api:{}},J=function(a,b){return[].slice.call(a,Number(b)||0)},z=function(a){return J(a,-1)[0]},I=function(){return a.ajaxSetup({type:"post",dataType:"json"}),a(document).ajaxError(function(a,b){var c;return c=b.responseText,!1})},M=function(b,c,d,e){var f,g,h,i;return i=!1,"string"===a.type(b)&&(b=b.toLowerCase(),a.isFunction(a.fn.dialog)?(h="systemDialog",g=K.i18n._SYS.dialog[O.config("lang")],K.pool.hasOwnProperty(h)||(K.pool[h]={}),f=K.pool[h][b],f||(f=a('<div data-role="dialog" data-type="system" />').appendTo(a("body")).on({dialogcreate:w("systemDialog"),dialogopen:function(){return a(".ui-dialog-buttonset .ui-button",a(this).closest(".ui-dialog")).each(function(){var c;switch(c=a(this),a.trim(c.text())){case g.ok:b="ok";break;case g.cancel:b="cancel";break;case g.yes:b="yes";break;case g.no:b="no"}return c.addClass("ui-button-"+b)})}}).dialog({title:g.title,width:400,minHeight:100,closeText:g.close,modal:!0,autoOpen:!1,resizable:!1,closeOnEscape:!1}),K.pool[h][b]=f,f.closest(".ui-dialog").find(".ui-dialog-titlebar-close").remove()),i=N(b,c,d,e)):(i=!0,"alert"===b?window.alert(c):window.confirm(c)?a.isFunction(d)&&d():a.isFunction(e)&&e())),i},N=function(b,c,d,e){var f,g,h,i,j,k;return k=K.i18n._SYS.dialog[O.config("lang")],j=function(b,c){return a(this).dialog("close"),a.isFunction(b)&&b(),c},g=[],f={ok:k.ok,cancel:k.cancel,yes:k.yes,no:k.no},h=K.pool.systemDialog[b],i=a("[data-role='dialog-content']",h),0===i.size()&&(i=h),"confirm"===b?(g.push({text:f.ok,click:function(){return j.apply(this,[d,!0]),!0}}),g.push({text:f.cancel,click:function(){return j.apply(this,[e,!1]),!0}})):"confirmex"===b?(g.push({text:f.yes,click:function(){return j.apply(this,[d,!0]),!0}}),g.push({text:f.no,click:function(){return j.apply(this,[e,!1]),!0}}),g.push({text:f.cancel,click:function(){return j.apply(this,[null,!1]),!0}})):(b="alert",null!==d?g.push({text:f.ok,click:function(){return j.apply(this,[d,!0]),!0}}):g=null),i.html(c||""),h.dialog("option","buttons",g).dialog("open")},q=function(){var b,c,d,e,f,g;if(b=arguments,g=b[0],f=b[1],c=K.fn.handler,0===b.length)f=r(c);else if("string"==typeof g)a.isFunction(f)?c[g]=f:f=c[g];else if(a.isPlainObject(g))for(e in g)d=g[e],a.isFunction(d)&&(c[e]=d);return f},F=function(b){var c,d,e,f,g;if(c=J(arguments,1),d=K.fn.handler[b],e=null,"string"==typeof b&&a.isFunction(d))e=d.apply(window,c);else if(a.isArray(b))for(f=0,g=b.length;g>f;f++)d=b[f],a.isFunction(d)&&d.call(window);return e},C=function(b,c){return a.isFunction(b)?K.fn[c].push(b):void 0},r=function(b){var c;return c=null,a.isArray(b)||void 0!==b.length?c=[].concat([],J(b)):a.isPlainObject(b)&&(c=a.extend(!0,{},b)),c},w=function(a){return K.fn.init[a]},u=function(b,c){var d,e;return d=b.split("."),e=null,(c||!y(d[0],B.key.storage))&&(e=K,a.each(d,function(a,b){var c;return c=e.hasOwnProperty(b),e=e[b],c})),e},H=function(b,c){var d,e,f,g,h;return g=b.split("."),f=g.length,d=a.isPlainObject(c),1===f?(e=g[0],h=G(K,e,c,K.hasOwnProperty(e))):(h=K,a.each(g,function(b,d){return f-1>b?h.hasOwnProperty(d)||(h[d]={}):h[d]=G(h,d,c,a.isPlainObject(h[d])),h=h[d],!0})),h},G=function(b,c,d,e){return e&&a.isPlainObject(d)?a.extend(!0,b[c],d):b[c]=d,b[c]},x=function(b,c,d){return"object"===a.type(b)&&"string"===a.type(c)&&b.hasOwnProperty(c)&&a.type(b[c])===d},y=function(b,c){return a.inArray(b,c)>-1},A=function(a){return B.key.storage.push(a)},a.extend(O,{alert:function(a,b){return M("alert",a,b)},confirm:function(a,b,c){return M("confirm",a,b,c)},confirmEX:function(a,b,c){return M("confirmEX",a,b,c)},queue:function(){return q.apply(window,J(arguments))},run:function(){return F.apply(window,J(arguments))},url:function(){var b,c;return b=window.location,c={search:b.search.substring(1),hash:b.hash.substring(1),query:{}},a.each(c.search.split("&"),function(b,d){return d=d.split("="),""!==a.trim(d[0])?c.query[d[0]]=d[1]:void 0}),c},download:function(a,b){var c,d,e;return window.ActiveXObject?window.ActiveXObject&&document.execCommand?(e=window.open(a,"_blank"),e.document.close(),e.document.execCommand("SaveAs",!0,b||a),e.close()):void 0:(d=document.createElement("a"),d.href=a,d.target="_blank",d.download=b||"unknown",c=document.createEvent("Event"),c.initEvent("click",!0,!0),d.dispatchEvent(c),(window.URL||window.webkitURL).revokeObjectURL(d.href))},functionExists:function(a,b){return x(b===!0?window:K.fn.handler,a,"function")},pad:function(b,c,d){var e,f,g;if(a.type(b)in{string:!0,number:!0}&&(("string"!==a.type(d)||1!==d.length)&&(d=" "),a.isNumeric(c)&&/^-?[1-9]\d*$/.test(c)||(c=0),b=String(b),e=1,g=String(d),f=Math.abs(c)-b.length,f>0)){for(;f>e;)d+=g,e++;b=c>0?b+d:d+b}return b},zerofill:function(b,c){var d,e,f,g;return f="",a.isNumeric(b)&&a.isNumeric(c)&&/^-?[1-9]\d*$/.test(c)&&(g=/^([-+]?\d+)\.(\d+)$/,d=g.test(b),e="",c=parseInt(c),c>0&&d?(b=(""+b).match(g),e=""+1*b[1]+".",b=b[2]):0>1*b&&(e="-",b=(""+b).substring(1)),f=this.pad(b,c,"0"),f=0>c&&d?"":e+f),f}}),E=function(b){return r(a.isPlainObject(b)?a.extend(K.config,b):K.config)},a.extend(O,{sandbox:function(b){var c;return K.sandboxStarted!==!0&&(c=E(b),F(K.fn.prepare),a(document).ready(function(){return F(K.fn.ready)}),K.sandboxStarted=!0),c||!1},prepare:function(a){return C(a,"prepare")},ready:function(a){return C(a,"ready")}}),v=function(){var b,c,d;return b=arguments,d=b[0],c=b[1],a.isPlainObject(d)?a.each(d,v):"string"===a.type(d)&&K.fn.init.hasOwnProperty(d)&&a.isFunction(c)?K.fn.init[d]=c:void 0},p=function(){var b;return b=O.config("api"),"string"===a.type(b)&&""!==a.trim(b)?"/"+b:""},a.extend(O,{mask:function(b){var c;return c=!1,"string"===a.type(b)&&(window.hasOwnProperty(b)?window.console&&console.error("'"+b+"' has existed as a property of Window object."):(window[b]=window[k.name],c=delete window[k.name],k.name=b)),c},config:function(b){return"string"===a.type(b)?K.config[b]:r(K.config)},init:function(){return v.apply(window,J(arguments))},i18n:function(){var b,c,d,e;return b=arguments,d=b[0],e=null,a.isPlainObject(d)?a.extend(K.i18n,d):n.test(d)&&(c=b[1],(2!==b.length||"string"!=typeof c||n.test(c))&&(a.isPlainObject(c)?(e=u("i18n."+d,!0),e=("string"==typeof e?e:"").replace(/\{%\s*([A-Z0-9_]+)\s*%\}/gi,function(a,b){return c[b]})):(e="",a.each(b,function(a,b){var c;return"string"==typeof b&&n.test(b)?(c=u("i18n."+b,!0),e+="string"==typeof c?c:""):void 0})))),e},api:function(){var b,c,d,e,f,g,h,i;return b=arguments,d=b[0],g=null,a.isPlainObject(d)?a.extend(K.web_api,d):"string"===a.type(d)&&(f=/^([a-z]+)_/,e=(null!=(i=d.match(f))?i:[])[1],c=b[1],h=void 0,a.each(["front","admin"],function(a,b){return e===b?(h=b,!1):void 0}),h?d=d.replace(f,""):h="common",g=p()+u("web_api."+h+"."+d,!0),a.isPlainObject(c)&&(g=g.replace(/\:([a-z_]+)/g,function(a,b){return c[b]}))),g}}),t=function(b){var c,d;return c={},d=b.match(/<[a-z]+[^>]*>/i),null!==d&&a.each(d[0].match(/(data(-[a-z]+)+=[^\s>]*)/gi)||[],function(b,d){return d=d.match(/data-(.*)="([^\s"]*)"/i),c[a.camelCase(d[1])]=d[2],!0}),c},s=function(c){var d;return d={},a.each(c,function(c,e){var f;return e.nodeType===b&&(f=e.nodeName.match(/^data-(.*)$/i))&&(d[a.camelCase(f(1))]=e.nodeValue),!0}),d},a.extend(O,{data:function(){var b,c,d,e,f,g;if(b=arguments,d=b.length,d>0){g=b[0];try{e=a(g).get(0)}catch(i){c=i,e=g}e&&e.nodeType===h?(f={},e.dataset?f=e.dataset:e.outerHTML?f=t(e.outerHTML):e.attributes&&a.isNumeric(e.attributes.length)&&(f=s(e.attributes))):"string"==typeof g&&n.test(g)&&(f=1===d?u(g):H(g,b[1]),d>1&&z(b)===!0&&A(g.split(".")[0]))}return f||null},save:function(){var b,c,d,e;return b=arguments,c=b[0],e=b[1],L.storage&&"string"==typeof c?(d=this.access(c),localStorage.setItem(c,escape(a.isPlainObject(d)?JSON.stringify(a.extend(d,e)):e))):void 0},access:function(){var a,b,c;if(b=arguments[0],"string"==typeof b&&L.storage&&(c=localStorage.getItem(b),null!==c)){c=unescape(c);try{c=JSON.parse(c)}catch(d){a=d,c=c}}return c||null}}),D=function(b,c,d,e){var f;if(0!==arguments.length)return a.isPlainObject(b)===!1&&(b={url:b}),f=w("ajaxHandler")(c,d),a.isFunction(b.success)||(b.success=f.success),a.isFunction(b.error)||(b.error=f.error),a.ajax(a.extend(b,{async:e!==!0}))},a.extend(O,{ajax:function(a,b,c){return D(a,b,c)},sjax:function(a,b,c){return D(a,b,c,!0)}}),a.extend(O,{encodeEntities:function(b){return"string"===a.type(b)?b.replace(/([<>&\'\"])/,function(a,b){var c;switch(b){case"<":c=lt;break;case">":c=gt;break;case'"':c=quot;break;case"'":c=apos;break;case"&":c=amp}return"&"+c+";"}):b},decodeEntities:function(){}}),window[k.name]=O}).call(this);